<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="canonical" href="http://docs.sandbox.io/gateway/">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>DNS and DHCP - Deve Linux Sandbox Project</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "DNS and DHCP";
    var mkdocs_page_input_path = "gateway.md";
    var mkdocs_page_url = "/gateway/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Deve Linux Sandbox Project</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">DNS and DHCP</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#installation-and-setup">Installation and Setup</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#proxmox-setup">Proxmox Setup</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#dhcp-server-setup">DHCP server setup</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#dns-server-setup">DNS Server setup</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#namedconf-configuration">named.conf configuration</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#forward-and-reverse-lookup-zone">Forward and reverse lookup zone</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#firewall-plus-other-settings">Firewall plus other settings</a>
    </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../spacewalk/">Spacewalk</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../docs/">Documentation</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../freeipa/">FreeIPA</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../bot/">Automation</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../storage/">Storage</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../backup/">Backup</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../app/">Application</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../mail/">Mail</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../monitoring/">Monitoring</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../logs/">Logs</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../auth/">Authority</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Deve Linux Sandbox Project</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>DNS and DHCP</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="dns-and-dhcp-server">DNS and DHCP Server</h1>
<h2 id="installation-and-setup">Installation and Setup</h2>
<h2 id="proxmox-setup">Proxmox Setup</h2>
<p>Create a linux bridge on the proxmox server to isolate the network to other side</p>
<p><a href="../assets/images/dnsdhcp/dnsdhcp-image-01.jpg"><img alt="" src="../assets/images/dnsdhcp/dnsdhcp-image-01.jpg" /></a></p>
<p>Perform a reboot on the server, once it is done we can create a KVM or LXC. then after creating the virtual machine we need to other NIC on it and link it to the created linux bridge.</p>
<p><a href="../assets/images/dnsdhcp/dnsdhcp-image-02.jpg"><img alt="" src="../assets/images/dnsdhcp/dnsdhcp-image-02.jpg" /></a></p>
<p>Start the VM, ensure the KVM/LXC have a second NIC, on my end it is eth1</p>
<pre><code>[root@dns-dhcp ~]# ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether e2:67:0e:2f:3a:7d brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 192.168.254.107/24 brd 192.168.254.255 scope global dynamic eth0
       valid_lft 250156sec preferred_lft 250156sec
    inet6 fe80::e067:eff:fe2f:3a7d/64 scope link 
       valid_lft forever preferred_lft forever
3: eth1@if15: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether 0a:bf:e2:77:5c:5f brd ff:ff:ff:ff:ff:ff link-netnsid 0
</code></pre>
<p>Install necessary packages:</p>
<p><code>yum install -y iptables iptables-services bind bind-utils bind-libs dhcp</code></p>
<pre><code>[root@dns-dhcp ~]# yum install -y iptables iptables-services bind bind-utils bind-libs dhcp
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
 * base: mirror.hostlink.com.hk
 * extras: mirror.hostlink.com.hk
 * updates: mirror.hostlink.com.hk
Package iptables-services-1.4.21-35.el7.x86_64 already installed and latest version
Package iptables-1.4.21-35.el7.x86_64 already installed and latest version
Package 32:bind-9.11.4-26.P2.el7_9.8.x86_64 already installed and latest version
Package 32:bind-utils-9.11.4-26.P2.el7_9.8.x86_64 already installed and latest version
Package 32:bind-libs-9.11.4-26.P2.el7_9.8.x86_64 already installed and latest version
Package 12:dhcp-4.2.5-83.el7.centos.1.x86_64 already installed and latest version
Nothing to do
</code></pre>
<p>Disable and stop firewalld as we will use iptables as the firewall</p>
<p><code>systemctl stop firewalld &amp;&amp; systemctl disable firewalld</code></p>
<p>eth1 configuration must be set below:</p>
<pre><code>DEVICE=eth1
BOOTPROTO=none
IPADDR=10.11.100.1
NETMASK=255.255.255.0
ONBOOT=yes
NM_CONTROLLED=no
TYPE=Ethernet
DNS1="127.0.0.1"
</code></pre>
<p>After that you need to restart network service or use ifdown/up command</p>
<pre><code>[root@dns-dhcp ~]# systemctl restart network
[root@dns-dhcp ~]# ip a
3: eth1@if15: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 0a:bf:e2:77:5c:5f brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 10.11.101.1/24 brd 10.11.101.255 scope global eth1
       valid_lft forever preferred_lft forever
    inet6 fe80::8bf:e2ff:fe77:5c5f/64 scope link
       valid_lft forever preferred_lft forever
</code></pre>
<h2 id="dhcp-server-setup">DHCP server setup</h2>
<p>Edit dhcpd.conf to use spacewalk ip address as next-server for pxe</p>
<pre><code>default-lease-time 600;
max-lease-time 7200;
log-facility local7;
authoritative;
ignore client-updates;

subnet 10.11.100.0 netmask 255.255.255.0{
        range 10.11.100.10 10.11.100.50;
        option routers 10.11.100.1;
        option subnet-mask 255.255.255.0;
        option domain-name-servers 10.11.100.1;
        option domain-name "sandbox.io";
        next-server 10.11.100.101;
        filename "pxelinux.0";
}
</code></pre>
<p>For static IP assigning, see below as an example: </p>
<pre><code>host spacewalk {
        hardware ethernet 3E:D1:95:C2:49:9C;
        fixed-address 10.11.100.101;
}
</code></pre>
<p>Enable and start dhcpd server</p>
<p><code>systemctl enable --now dhcpd</code></p>
<p>You should be able to verify that dhcpd is working via journalctl</p>
<pre><code>Dec 06 11:52:47 dns-dhcp dhcpd[1681]: DHCPDISCOVER from de:a9:15:7b:de:e1 via eth1
Dec 06 11:52:48 dns-dhcp dhcpd[1681]: DHCPOFFER on 10.11.100.10 to de:a9:15:7b:de:e1 (client-test) via eth1
Dec 06 11:52:48 dns-dhcp dhcpd[1681]: DHCPREQUEST for 10.11.100.10 (10.11.100.1) from de:a9:15:7b:de:e1 (client-test) via eth1
Dec 06 11:52:48 dns-dhcp dhcpd[1681]: DHCPACK on 10.11.100.10 to de:a9:15:7b:de:e1 (client-test) via eth1
</code></pre>
<h2 id="dns-server-setup">DNS Server setup</h2>
<h3 id="namedconf-configuration">named.conf configuration</h3>
<p>Edit /etc/named.conf file, this file is the main configuration file of the bind package manager</p>
<pre><code>options {
        listen-on port 53 { 127.0.0.1; 10.11.100.1; };
        listen-on-v6 port 53 { ::1; };
        directory       "/var/named";
        dump-file       "/var/named/data/cache_dump.db";
        statistics-file "/var/named/data/named_stats.txt";
        memstatistics-file "/var/named/data/named_mem_stats.txt";
        recursing-file  "/var/named/data/named.recursing";
        secroots-file   "/var/named/data/named.secroots";
        allow-query     { localhost; 10.11.100.0/24; };
        allow-transfer  { localhost; 192.168.254.254; };
        recursion yes;
        dnssec-enable yes;
        dnssec-validation yes;
        bindkeys-file "/etc/named.iscdlv.key";
        managed-keys-directory "/var/named/dynamic";
        pid-file "/run/named/named.pid";
        session-keyfile "/run/named/session.key";
};
</code></pre>
<p>On the lower part of /etc/named.conf file, add the filenames on where you will put DNS records.</p>
<pre><code>zone "." IN {
        type hint;
        file "named.ca";
};

zone "sandbox.io" IN {
        type master;
        file "sandbox.forward";
        allow-update { none; };
};

zone "100.11.10.in-addr.arpa" IN {
        type master;
        file "sandbox.reverse";
        allow-update { none; };
};
</code></pre>
<h3 id="forward-and-reverse-lookup-zone">Forward and reverse lookup zone</h3>
<p>The file sandbox.forward and sandbox.reverse that was stated in named.conf file needs to be created in /var/named</p>
<pre><code>touch /var/named/sandbox.{forward,reverse}
[root@dhcp-dns-copy ~]# ls -ld /var/named/sandbox.{forward,reverse}
-rw-r--r-- 1 root root 0 Dec  6 12:38 /var/named/sandbox.forward
-rw-r--r-- 1 root root 0 Dec  6 12:38 /var/named/sandbox.reverse
</code></pre>
<p>Both of those file will have the same heading template like below in order to work</p>
<pre><code>$TTL 86400
@       IN      SOA     dnsdhcp.sandbox.io.     root.sandbox.io (
        2011071001      ;Serial
        3600    ;Refresh
        1800    ;Retry
        604800  ;Expire
        86400   ;Minimum TTL
)
</code></pre>
<p>For every hostname, domain name should be stated with its ip address</p>
<p>/etc/named/sandbox.forward</p>
<pre><code>@           IN  NS  dnsdhcp.sandbox.io.
@           IN  A   10.11.100.1
dnsdhcp     IN  A   10.11.100.1
dns-dhcp    IN CNAME    dnsdhcp #if CNAME is needed
</code></pre>
<p>/etc/named/sandbox.reverse</p>
<pre><code>@           IN  NS  dnsdhcp.sandbox.io.
dnsdhcp     IN  A   10.11.100.1
1           IN  PTR dnsdhcp.sandbox.io.
</code></pre>
<p>Start and enable bind service</p>
<p><code>systemctl enable --now named</code></p>
<p>You should have response on the DNS server when doing nslookup</p>
<pre><code>[root@dns-dhcp ~]# nslookup dnsdhcp
Server:         127.0.0.1
Address:        127.0.0.1#53

Name:   dnsdhcp.sandbox.io
Address: 10.11.100.1

[root@dns-dhcp ~]# nslookup 10.11.100.1
1.100.11.10.in-addr.arpa        name = dnsdhcp.sandbox.io.
</code></pre>
<h2 id="firewall-plus-other-settings">Firewall plus other settings</h2>
<p>Iptables firewall configuration must be configured same as below, alternatively you can add this to /etc/sysconfig/iptables then restart iptables: <code>systemctl restart iptables</code></p>
<pre><code>*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [33:3512]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -i eth1 -s 10.11.100.0/24 -p tcp --dport 53 -j ACCEPT
-A INPUT -i eth1 -s 10.11.100.0/24 -p udp --dport 53 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -i eth0 -o eth1 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i eth1 -o eth0 -j ACCEPT
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
*nat
:PREROUTING ACCEPT [76:8121]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [6:1968]
:POSTROUTING ACCEPT [6:1968]
-A POSTROUTING -o eth0 -j MASQUERADE
COMMIT
</code></pre>
<p>If you want to do it on command line, just insert <code>iptables</code> command on every rule. Note that when dealing the Postrouting rule, we need to insert <code>-t nat</code> too</p>
<pre><code>iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
</code></pre>
<p>You can check the rules via <code>iptables -L</code>, and <code>iptables -t nat -nvL</code> for the postrouting rule. save the rule when done</p>
<pre><code>[root@dns-dhcp ~]# iptables -L
Chain INPUT (policy ACCEPT)
target     prot opt source               destination
ACCEPT     all  --  anywhere             anywhere             state RELATED,ESTABLISHED
ACCEPT     icmp --  anywhere             anywhere
ACCEPT     all  --  anywhere             anywhere
ACCEPT     tcp  --  anywhere             anywhere             state NEW tcp dpt:ssh
ACCEPT     tcp  --  10.11.100.0/24       anywhere             tcp dpt:domain
ACCEPT     udp  --  10.11.100.0/24       anywhere             udp dpt:domain
REJECT     all  --  anywhere             anywhere             reject-with icmp-host-prohibited

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination
ACCEPT     all  --  anywhere             anywhere             state RELATED,ESTABLISHED
ACCEPT     all  --  anywhere             anywhere
REJECT     all  --  anywhere             anywhere             reject-with icmp-host-prohibited

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination

[root@dns-dhcp ~]# iptables -t nat -nvL

Chain PREROUTING (policy ACCEPT 87 packets, 9331 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain INPUT (policy ACCEPT 4 packets, 260 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 12 packets, 3420 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain POSTROUTING (policy ACCEPT 12 packets, 3420 bytes)
 pkts bytes target     prot opt in     out     source               destination
   17  1428 MASQUERADE  all  --  *      eth0    0.0.0.0/0            0.0.0.0/0

[root@dns-dhcp ~]# iptables-save &gt; /etc/sysconfig/iptables # or service iptables save
[root@dns-dhcp ~]# systemctl restart iptables
</code></pre>
<p>Execute this on the command line to add ip forwarding in sysctl.conf</p>
<p><code>echo net.ipv4.ip_forward = 1 &gt;&gt; /etc/sysctl.conf</code> </p>
<p>Reboot the server</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../spacewalk/" class="btn btn-neutral float-right" title="Spacewalk">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href=".." class="btn btn-neutral" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href=".." style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../spacewalk/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
